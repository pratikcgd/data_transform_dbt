

  create or replace table `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`REFERRALS`
  
  
  OPTIONS()
  as (
    

WITH referrals as (

select
SAFE_CAST(hub.OMD_NPS_SITE_ID as string) as SITE_ID,
SAFE_CAST(hsp.HUB_SITE_PATIENT_SK as string) as PATIENT_NUMBER,
NULL as RECORD_ID,
NULL as PROVIDER_ID,
SAFE_CAST(satt.PROVIDER_NAME as string) as PROVIDER_NAME,
SAFE_CAST(satt.TEST_NAME as string) as CATEGORY_NAME,
SAFE_CAST(satt.PROVIDER_REFERENCE as string) as PROVIDER_REFERENCE,
NULL as REFERRAL_ID,
NULL as REFERRAL_CODE,
NULL as REFERRING_DOCTOR,
NULL as REFERRAL_DATE,
SAFE_CAST(satt.CREATED_BY as string) as CREATED_BY,
SAFE_CAST(satt.CREATED_DATETIME as timestamp) as CREATED_DATETIME,
SAFE_CAST(satt.UPDATED_BY as string) as UPDATED_BY,
SAFE_CAST(satt.UPDATED_DATETIME as timestamp) as UPDATED_DATETIME,
SAFE_CAST(satt.RECORD_STATUS as int) AS RECORD_STATUS,
SAFE_CAST(hub.SOURCE_SYSTEM AS STRING) AS SOURCE_SYSTEM,
SAFE_CAST("SAT_SITE_PATIENT_BP_OMOP" AS STRING) AS SOURCE_TABLE,
from 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_PATHOLOGY_BP_OMOP` satt
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PATHOLOGY_OMOP` hub
on satt.HUB_PATHOLOGY_SK = hub.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_PATHOLOGY_OMOP` lnk
on hub.HUB_PATHOLOGY_SK = lnk.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_PATHOLOGY_OMOP` lsat
on lnk.LNK_PATHOLOGY_SK = lsat.LNK_PATHOLOGY_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON lnk.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_BP_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
where
    lsat.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsat.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N'

UNION ALL


select
SAFE_CAST(hub.OMD_NPS_SITE_ID as string) as SITE_ID,
SAFE_CAST(hsp.HUB_SITE_PATIENT_SK as string) as PATIENT_NUMBER,
NULL as RECORD_ID,
NULL as PROVIDER_ID,
SAFE_CAST(satt.LAB_NAME as string) as PROVIDER_NAME,
SAFE_CAST(satt.TEST_NAME as string) as CATEGORY_NAME,
SAFE_CAST(satt.LAB_REFERENCE as string) as PROVIDER_REFERENCE,
SAFE_CAST(satt1.REF_ID as string) as REFERRAL_ID,
NULL as REFERRAL_CODE,
NULL as REFERRING_DOCTOR,
NULL as REFERRAL_DATE,
NULL as CREATED_BY,
SAFE_CAST(satt.STAMP_CREATED_DATETIME as timestamp) as CREATED_DATETIME,
NULL as UPDATED_BY,
SAFE_CAST(satt.STAMP_DATETIME as timestamp) as UPDATED_DATETIME,
NULL AS RECORD_STATUS,
SAFE_CAST(hub.SOURCE_SYSTEM AS STRING) AS SOURCE_SYSTEM,
SAFE_CAST("SAT_SITE_PATIENT_MD_OMOP" AS STRING) AS SOURCE_TABLE,
from 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_PATHOLOGY_MD_OMOP` satt
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PATHOLOGY_OMOP` hub
on satt.HUB_PATHOLOGY_SK = hub.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_PATHOLOGY_OMOP` lnk
on hub.HUB_PATHOLOGY_SK = lnk.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_PATHOLOGY_OMOP` lsat
on lnk.LNK_PATHOLOGY_SK = lsat.LNK_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_BILLING_PATIENT_OMOP` lnkb
on lnk.HUB_SITE_PATIENT_SK = lnkb.HUB_SITE_PATIENT_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_BILLING_MD_OMOP` satt1
on lnkb.HUB_BILLING_SK = satt1.HUB_BILLING_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_BILLING_PATIENT_OMOP` lsatb
on lnkb.LNK_BILLING_PATIENT_SK = lsatb.LNK_BILLING_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON lnkb.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_MD_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
where
    lsat.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsat.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND lsatb.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsatb.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt1.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt1.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N'

UNION ALL

--- REFERRAL_CODE, REFERRING_DOCTOR and REFERRAL_DATE only applicable to PHC. 

select
SAFE_CAST(hub.OMD_NPS_SITE_ID as string) as SITE_ID,
SAFE_CAST(hsp.HUB_SITE_PATIENT_SK as string) as PATIENT_NUMBER,
NULL as RECORD_ID,
SAFE_CAST(satt.PROVIDER_ID as string) as PROVIDER_ID,
SAFE_CAST(satt.PROVIDER_NAME as string) as PROVIDER_NAME,
SAFE_CAST(satt.TEST_NAME as string) as CATEGORY_NAME,
SAFE_CAST(satt.PROVIDER_REFERENCE as string) as PROVIDER_REFERENCE,
SAFE_CAST(satt1.REFERRAL_ID as string) as REFERRAL_ID,
SAFE_CAST(ssp.REFERRAL_CODE as STRING) as REFERRAL_CODE,
SAFE_CAST(ssp.REFERRING_DOCTOR as STRING) as REFERRING_DOCTOR,
SAFE_CAST(ssp.REFERRAL_DATE as TIMESTAMP) as REFERRAL_DATE,
SAFE_CAST(satt.CREATED_BY as STRING) as CREATED_BY,
SAFE_CAST(satt.CREATED_DATETIME as timestamp) as CREATED_DATETIME,
SAFE_CAST(satt.UPDATED_BY as STRING) as UPDATED_BY,
SAFE_CAST(satt.UPDATED_DATETIME as timestamp) as UPDATED_DATETIME,
SAFE_CAST(satt.RECORD_STATUS as int) AS RECORD_STATUS,
SAFE_CAST(hub.SOURCE_SYSTEM AS STRING) AS SOURCE_SYSTEM,
SAFE_CAST("SAT_SITE_PATIENT_PHC_BP_OMOP" AS STRING) AS SOURCE_TABLE,
from 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_PATHOLOGY_PHC_BP_OMOP` satt
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PATHOLOGY_OMOP` hub
on satt.HUB_PATHOLOGY_SK = hub.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_PATHOLOGY_OMOP` lnk
on hub.HUB_PATHOLOGY_SK = lnk.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_PATHOLOGY_OMOP` lsat
on lnk.LNK_PATHOLOGY_SK = lsat.LNK_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_BILLING_PATIENT_OMOP` lnkb
on lnk.HUB_SITE_PATIENT_SK = lnkb.HUB_SITE_PATIENT_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_BILLING_PHC_BP_OMOP` satt1
on lnkb.HUB_BILLING_SK = satt1.HUB_BILLING_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_BILLING_PATIENT_OMOP` lsatb
on lnkb.LNK_BILLING_PATIENT_SK = lsatb.LNK_BILLING_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON lnkb.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_PHC_BP_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
where
    lsat.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsat.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND lsatb.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsatb.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt1.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt1.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N'

UNION ALL

select
SAFE_CAST(hub.OMD_NPS_SITE_ID as string) as SITE_ID,
SAFE_CAST(hsp.HUB_SITE_PATIENT_SK as string) as PATIENT_NUMBER,
NULL as RECORD_ID,
NULL as PROVIDER_ID,
SAFE_CAST(satt.LAB_NAME as string) as PROVIDER_NAME,
SAFE_CAST(satt.TEST_NAME as string) as CATEGORY_NAME,
SAFE_CAST(satt.LAB_REFERENCE as string) as PROVIDER_REFERENCE,
SAFE_CAST(satt1.REF_ID as string) as REFERRAL_ID,
SAFE_CAST(ssp.REFERRING_CODE as STRING) as REFERRAL_CODE,
SAFE_CAST(ssp.REFERRING_DOCTOR as STRING) as REFERRING_DOCTOR,
SAFE_CAST(ssp.REFERRING_DATE as TIMESTAMP) as REFERRAL_DATE,
NULL as CREATED_BY,
SAFE_CAST(satt.STAMP_CREATED_DATETIME as timestamp) as CREATED_DATETIME,
NULL as UPDATED_BY,
SAFE_CAST(satt.STAMP_DATETIME as timestamp) as UPDATED_DATETIME,
NULL AS RECORD_STATUS,
SAFE_CAST(hub.SOURCE_SYSTEM AS STRING) AS SOURCE_SYSTEM,
SAFE_CAST("SAT_SITE_PATIENT_PHC_MD_OMOP" AS STRING) AS SOURCE_TABLE,
from 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_PATHOLOGY_PHC_MD_OMOP` satt
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PATHOLOGY_OMOP` hub
on satt.HUB_PATHOLOGY_SK = hub.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_PATHOLOGY_OMOP` lnk
on hub.HUB_PATHOLOGY_SK = lnk.HUB_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_PATHOLOGY_OMOP` lsat
on lnk.LNK_PATHOLOGY_SK = lsat.LNK_PATHOLOGY_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_BILLING_PATIENT_OMOP` lnkb
on lnk.HUB_SITE_PATIENT_SK = lnkb.HUB_SITE_PATIENT_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_BILLING_PHC_MD_OMOP` satt1
on lnkb.HUB_BILLING_SK = satt1.HUB_BILLING_SK
INNER join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_BILLING_PATIENT_OMOP` lsatb
on lnkb.LNK_BILLING_PATIENT_SK = lsatb.LNK_BILLING_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON lnkb.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_PHC_MD_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
where
    lsat.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsat.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND lsatb.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND lsatb.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND satt1.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND satt1.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N'

)

SELECT distinct * FROM referrals
  );
  