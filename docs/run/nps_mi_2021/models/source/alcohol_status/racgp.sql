

  create or replace view `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021_VIEWS_ONLY`.`racgp`
  OPTIONS()
  as 

with racp as (

select
w.VISIT_DATE,
q.PATIENT_NUMBER,
q.SITE_ID,
q.PATIENT_CITY,
q.PATIENT_POSTCODE,
q.GENDER_CODE,
q.GENDER_NAME,
q.YEAR_OF_BIRTH,
q.YEAR_OF_DEATH,
q.DECEASED_INDICATOR,
q.ATSI_CODE,
q.ATSI_NAME,
q.PENSION_CODE,
q.PENSION_NAME,
q.CIS_PATIENT_STATUS_CODE,
q.CIS_PATIENT_STATUS_NAME,
q.PATIENT_CREATED_DATE,    
q.PATIENT_MODIFIED_DATE,
q.PHN_CODE,
q.SITE_POSTCODE,
y.STATE,
e.ALCOHOL_CODE,
e.ALCOHOL_STATUS_NAME,
r.ALLERGY_STATUS_CODE,
r.ALLERGY_STATUS_NAME,
t.SMOKING_STATUS_CODE,
t.SMOKING_STATUS_NAME,
t.SMOKING_FREQUENCY,
t.SMOKES_PER_DAY
from `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`PATIENT` q 
left join
`nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`ENCOUNTER` w 
on q.PATIENT_NUMBER = w.PATIENT_NUMBER
left join 
`nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`ALCOHOL_STATUS` e 
on q.PATIENT_NUMBER = e.PATIENT_NUMBER
left join 
`nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`ALLERGY_REACTION` r
on q.PATIENT_NUMBER = r.PATIENT_NUMBER
left join 
`nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`SMOKING_STATUS` t
on q.PATIENT_NUMBER = t.PATIENT_NUMBER
left join 
`nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`SITE` y
on q.SITE_ID = y.SITE_NUMBER
WHERE (w.VISIT_DATE BETWEEN '2019-09-29' AND '2021-09-29') 
GROUP BY 
w.VISIT_DATE,q.PATIENT_NUMBER,q.SITE_ID,q.PATIENT_CITY,q.PATIENT_POSTCODE,q.GENDER_CODE,q.GENDER_NAME,
q.YEAR_OF_BIRTH,q.YEAR_OF_DEATH,q.DECEASED_INDICATOR,q.ATSI_CODE,q.ATSI_NAME,
q.PENSION_CODE,q.PENSION_NAME,q.CIS_PATIENT_STATUS_CODE,q.CIS_PATIENT_STATUS_NAME,q.PATIENT_CREATED_DATE,    
q.PATIENT_MODIFIED_DATE,q.PHN_CODE,q.SITE_POSTCODE,y.STATE,e.ALCOHOL_CODE,e.ALCOHOL_STATUS_NAME,
r.ALLERGY_STATUS_CODE,r.ALLERGY_STATUS_NAME,t.SMOKING_STATUS_CODE,t.SMOKING_STATUS_NAME, t.SMOKING_FREQUENCY, t.SMOKES_PER_DAY
having count(VISIT_DATE) >= 3
)

SELECT DISTINCT * FROM 
racp s1
where VISIT_DATE = (SELECT MAX(VISIT_DATE) 
FROM racp s2
WHERE s1.PATIENT_NUMBER = s2.PATIENT_NUMBER);

