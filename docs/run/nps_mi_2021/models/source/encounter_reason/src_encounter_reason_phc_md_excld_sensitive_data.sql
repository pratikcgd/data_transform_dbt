

  create or replace view `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021_VIEWS_ONLY`.`src_encounter_reason_phc_md_excld_sensitive_data`
  OPTIONS()
  as 

with encounter_reason_phc_md as (
select 
cast(leo.HUB_SITE_PATIENT_SK AS STRING) AS PATIENT_NUMBER,
cast(heo.SITE_ID AS STRING) AS SITE_ID,
NULL as PROVIDER_ID,
cast(heo.SOURCE_SYSTEM AS STRING) AS SOURCE_SYSTEM,
cast('SAT_ENCOUNTR_PHC_MD_EXCLD_SENSITIVE_DATA_OMOP' as STRING) AS SOURCE_TABLE,
cast(heo.ENCOUNTER_ID AS STRING) AS ENCOUNTER_ID,
cast(sepm.VISIT_DATE AS TIMESTAMP) AS VISIT_DATETIME,
cast(sepm.REASON as STRING) AS ENCOUNTER_REASONS,
cast(NULL AS STRING) AS ENCOUNTER_TYPE,
cast(sepm.REASON_CODE as STRING) AS ENCOUNTER_REASON_CODE,
cast(sepm.STAMP_CREATED_DATETIME as TIMESTAMP) AS CREATED_DATETIME,
cast(sepm.STAMP_DATETIME AS timestamp) as  UPDATED_DATETIME,
CAST(sepm.OMD_EFFECTIVE_DATETIME AS TIMESTAMP) AS OMD_EFFECTIVE_DATETIME,
CAST(sepm.OMD_SOURCE_ROW_ID AS INT) AS OMD_SOURCE_ROW_ID,
CAST(sepm.OMD_INSERT_MODULE_INSTANCE_ID AS INT) AS OMD_INSERT_MODULE_INSTANCE_ID,
CAST(sepm.OMD_EXPIRY_DATETIME AS TIMESTAMP) AS OMD_EXPIRY_DATETIME,
CAST(sepm.OMD_CURRENT_RECORD_INDICATOR AS STRING) AS OMD_CURRENT_RECORD_INDICATOR,
CAST(sepm.OMD_DELETED_RECORD_INDICATOR AS STRING) AS OMD_DELETED_RECORD_INDICATOR,
CAST(sepm.OMD_RECORD_SOURCE_ID AS INT) AS OMD_RECORD_SOURCE_ID,
CAST(sepm.OMD_HASH_FULL_RECORD AS STRING) AS OMD_HASH_FULL_RECORD
from
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_ENCOUNTER_OMOP` heo
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_ENCOUNTR_PHC_MD_EXCLD_SENSITIVE_DATA_OMOP` sepm
on heo.HUB_ENCOUNTER_SK = sepm.HUB_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_ENCOUNTER_OMOP` leo
on sepm.HUB_ENCOUNTER_SK = leo.HUB_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_ENCOUNTER_OMOP` lseo
on leo.LNK_ENCOUNTER_SK = lseo.LNK_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON leo.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_PHC_MD_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
WHERE
    sepm.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND sepm.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND lseo.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND lseo.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
    AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N'
)


select * from encounter_reason_phc_md;

