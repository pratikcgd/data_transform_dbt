

  create or replace view `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021_VIEWS_ONLY`.`src_script_item_phc_md`
  OPTIONS()
  as 

with script_item_phc_md as (
SELECT
    LNK_SCRIPT_ITEM.HUB_SITE_PATIENT_SK AS PATIENT_NUMBER,
    HUB_SCRIPT_ITEM.OMD_NPS_SITE_ID AS SITE_ID,
    HUB_SCRIPT_ITEM.SOURCE_SYSTEM AS SOURCE_SYSTEM,
    'SAT_SCRIPT_ITEM_PHC_MD_OMOP' AS SOURCE_TABLE,
    HUB_SCRIPT_ITEM.SCRIPT_ITEM_ID AS SCRIPT_ITEM_ID,
	HUB_PRESCRIPTION.PRESCRIPTION_ID AS PRESCRIPTION_ID,
	CAST(NULL AS STRING) AS PROVIDER_ID,
	CAST(NULL AS STRING) AS RECORD_STATUS,
	SAT_SCRIPT_ITEM.STRENGTH AS STRENGTH,
	SAT_SCRIPT_ITEM.DOSE AS DOSE,
	SAT_SCRIPT_ITEM.FREQUENCY AS FREQUENCY,
	CAST(NULL AS FLOAT64) AS PRN,
	SAT_SCRIPT_ITEM.ROUTE_CODE AS ROUTE,
	SAT_SCRIPT_ITEM.INSTRUCTIONS AS INSTRUCTIONS,
	SAT_SCRIPT_ITEM.QUANTITY AS QUANTITY,
	SAT_SCRIPT_ITEM.REPEATS AS REPEATS,
	SAT_SCRIPT_ITEM.REPEAT_INTERVAL AS REPEAT_INTERVAL,
	CAST(SAT_SCRIPT_ITEM.REGULATION_24 AS STRING) AS REGULATION_24,
	SAT_SCRIPT_ITEM.ITEM AS MEDICINE_NAME,
	SAT_MEDICINE_PRESCRIPTION.GENINT AS MEDICINE_ACTIVE_INGREDIENT,
	SAT_SCRIPT_ITEM.SCRIPT_CODE AS RESTRICTION_CODE,
	SAT_SCRIPT_ITEM.AUTHORITY_NO AS AUTHORITY_INDICATION,
	SAT_SCRIPT_ITEM.STAMP_USER_ID AS CREATED_BY,
	SAT_SCRIPT_ITEM.STAMP_CREATED_DATETIME AS CREATED_DATETIME,
	SAT_SCRIPT_ITEM.STAMP_USER_ID AS UPDATED_BY,
	SAT_SCRIPT_ITEM.STAMP_DATETIME AS UPDATED_DATETIME,
	CAST(SAT_SCRIPT_ITEM.GENERIC_SUBSTITUTION AS STRING) AS GENERIC_SUBSTITUTION_ALLOWED,
	CAST(HUB_SCRIPT.SCRIPT_ID AS STRING) AS SCRIPT_ID,
	SAT_SCRIPT_ITEM.SCRIPT_DATE AS SCRIPT_DATE,
	CAST(NULL AS STRING) AS PRINT_DATE,
	CAST(NULL AS FLOAT64) AS LOCATION_ID,
	CAST(NULL AS FLOAT64) AS IS_IMPORTED,
	CAST(NULL AS FLOAT64) AS SCRIPT_CREATED_BY,
	CAST(NULL AS STRING) AS SCRIPT_CREATED_DATETIME,
	CAST(NULL AS FLOAT64) AS SCRIPT_UPDATED_BY,
	CAST(NULL AS STRING) AS SCRIPT_UPDATED_DATETIME,
	CAST(SAT_SCRIPT_ITEM.OMD_EFFECTIVE_DATETIME AS TIMESTAMP) AS OMD_EFFECTIVE_DATETIME,
	SAT_SCRIPT_ITEM.OMD_SOURCE_ROW_ID AS OMD_SOURCE_ROW_ID,
	SAT_SCRIPT_ITEM.OMD_INSERT_MODULE_INSTANCE_ID AS OMD_INSERT_MODULE_INSTANCE_ID,
	CAST(SAT_SCRIPT_ITEM.OMD_EXPIRY_DATETIME AS TIMESTAMP) AS OMD_EXPIRY_DATETIME,
	SAT_SCRIPT_ITEM.OMD_CURRENT_RECORD_INDICATOR AS OMD_CURRENT_RECORD_INDICATOR,
	SAT_SCRIPT_ITEM.OMD_DELETED_RECORD_INDICATOR AS OMD_DELETED_RECORD_INDICATOR,
	SAT_SCRIPT_ITEM.OMD_RECORD_SOURCE_ID AS OMD_RECORD_SOURCE_ID,
	SAT_SCRIPT_ITEM.OMD_HASH_FULL_RECORD AS OMD_HASH_FULL_RECORD
FROM 
/** SCRIPT ITEM **/
    `nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SCRIPT_ITEM_OMOP` HUB_SCRIPT_ITEM
JOIN
    `nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SCRIPT_ITEM_PHC_MD_OMOP` SAT_SCRIPT_ITEM
ON
	HUB_SCRIPT_ITEM.HUB_SCRIPT_ITEM_SK = SAT_SCRIPT_ITEM.HUB_SCRIPT_ITEM_SK
JOIN
	 `nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_SCRIPT_SCRIPT_ITEM_OMOP` LNK_SCRIPT_ITEM
ON
	SAT_SCRIPT_ITEM.HUB_SCRIPT_ITEM_SK = LNK_SCRIPT_ITEM.HUB_SCRIPT_ITEM_SK
JOIN
	`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_SCRIPT_SCRIPT_ITEM_OMOP` LSAT_SCRIPT_ITEM
ON
	LNK_SCRIPT_ITEM.LNK_SCRIPT_SCRIPT_ITEM_SK = LSAT_SCRIPT_ITEM.LNK_SCRIPT_SCRIPT_ITEM_SK
JOIN
/** SCRIPT **/
    `nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SCRIPT_OMOP` HUB_SCRIPT
ON
	HUB_SCRIPT.HUB_SCRIPT_SK = LNK_SCRIPT_ITEM.HUB_SCRIPT_SK
JOIN
    `nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SCRIPT_PHC_MD_OMOP` SAT_SCRIPT
ON
	HUB_SCRIPT.HUB_SCRIPT_SK = SAT_SCRIPT.HUB_SCRIPT_SK
/** PRESCRIPTION **/
JOIN
	`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_PRESCRIPTION_OMOP` LNK_PRESCRIPTION
ON
	LNK_PRESCRIPTION.HUB_MEDICINE_SK = LNK_SCRIPT_ITEM.HUB_MEDICINE_SK
	AND LNK_PRESCRIPTION.HUB_SITE_PATIENT_SK = LNK_SCRIPT_ITEM.HUB_SITE_PATIENT_SK
JOIN
	`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_PRESCRIPTION_OMOP` LSAT_PRESCRIPTION
ON
	LNK_PRESCRIPTION.LNK_PRESCRIPTION_SK = LSAT_PRESCRIPTION.LNK_PRESCRIPTION_SK
JOIN
	`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PRESCRIPTION_OMOP` HUB_PRESCRIPTION
ON
	LNK_PRESCRIPTION.HUB_PRESCRIPTION_SK = HUB_PRESCRIPTION.HUB_PRESCRIPTION_SK
JOIN
	`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_MEDICINE_PHC_MD_OMOP` SAT_MEDICINE_PRESCRIPTION
ON
	LNK_PRESCRIPTION.HUB_MEDICINE_SK = SAT_MEDICINE_PRESCRIPTION.HUB_MEDICINE_SK
	AND LNK_SCRIPT_ITEM.HUB_MEDICINE_SK = SAT_MEDICINE_PRESCRIPTION.HUB_MEDICINE_SK
JOIN
/** PATIENT **/
	`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` HUB_PATIENT
ON
	LNK_SCRIPT_ITEM.HUB_SITE_PATIENT_SK = HUB_PATIENT.HUB_SITE_PATIENT_SK
	AND LNK_PRESCRIPTION.HUB_SITE_PATIENT_SK = HUB_PATIENT.HUB_SITE_PATIENT_SK
JOIN
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_PHC_MD_OMOP` SAT_PATIENT_PHC_MD
ON
	HUB_PATIENT.HUB_SITE_PATIENT_SK = SAT_PATIENT_PHC_MD.HUB_SITE_PATIENT_SK
/* Filters to retrieve non-deleted and current records */
WHERE
	SAT_SCRIPT_ITEM.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND SAT_SCRIPT_ITEM.OMD_DELETED_RECORD_INDICATOR = 'N'
	AND LSAT_SCRIPT_ITEM.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND LSAT_SCRIPT_ITEM.OMD_DELETED_RECORD_INDICATOR = 'N'
	AND LSAT_PRESCRIPTION.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND LSAT_PRESCRIPTION.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND SAT_SCRIPT.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND SAT_SCRIPT.OMD_DELETED_RECORD_INDICATOR = 'N'
	AND SAT_MEDICINE_PRESCRIPTION.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND SAT_MEDICINE_PRESCRIPTION.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND SAT_PATIENT_PHC_MD.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND SAT_PATIENT_PHC_MD.OMD_DELETED_RECORD_INDICATOR = 'N'
)

select * from script_item_phc_md;

