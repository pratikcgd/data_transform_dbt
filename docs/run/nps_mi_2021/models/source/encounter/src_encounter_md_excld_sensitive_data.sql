

  create or replace view `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021_VIEWS_ONLY`.`src_encounter_md_excld_sensitive_data`
  OPTIONS()
  as 

with encounter_md as (

select
cast(heo.ENCOUNTER_ID as STRING) as ENCOUNTER_ID,
cast(heo.SITE_ID AS STRING) AS SITE_ID,
cast(sebo.CREATED_DATETIME as STRING) as CREATED_DATETIME,
cast(sebo.UPDATED_DATETIME as STRING) as UPDATED_DATETIME,
cast(DATE(sebo.VISIT_DATE) as DATE) AS VISIT_DATE,
CAST(sebo.RECORD_START as STRING) AS ENCOUNTER_START_DATETIME,
CAST(sebo.RECORD_END as STRING) AS ENCOUNTER_END_DATETIME,
cast(sebo.DURATION as int) AS ENCOUNTER_DURATION,
cast(leo.HUB_SITE_PATIENT_SK AS STRING) as PATIENT_NUMBER,
cast(NULL as STRING) as PROVIDER_ID,
cast(heo.SOURCE_SYSTEM AS STRING) AS SOURCE_SYSTEM,
cast('SAT_ENCOUNTR_MD_EXCLD_SENSITIVE_DATA_OMOP' as STRING) as SOURCE_TABLE,
cast(sebo.VISIT_DATE as TIMESTAMP) AS VISIT_DATETIME,
cast(sebo.VISIT_TYPE as STRING) AS VISIT_TYPE,
cast(sbeo.LOGICAL_ENCOUNTER_COUNT as int) as LOGICAL_ENCOUNTER_COUNT,
cast(sbeo.PHYSICAL_ENCOUNTER_COUNT as int) as PHYSICAL_ENCOUNTER_COUNT,
cast(sbeo.EXACT_DUPLICATE_ENCOUNTER_COUNT as int) as EXACT_DUPLICATE_ENCOUNTER_COUNT,
cast(sbeo.CONTAINS_IMPORTED_ENCOUNTERS as STRING) as CONTAINS_IMPORTED_ENCOUNTERS,
CAST(sebo.OMD_EFFECTIVE_DATETIME AS TIMESTAMP) AS OMD_EFFECTIVE_DATETIME,
CAST(sebo.OMD_SOURCE_ROW_ID AS INT) AS OMD_SOURCE_ROW_ID,
CAST(sebo.OMD_INSERT_MODULE_INSTANCE_ID AS INT) AS OMD_INSERT_MODULE_INSTANCE_ID,
CAST(sebo.OMD_EXPIRY_DATETIME AS TIMESTAMP) AS OMD_EXPIRY_DATETIME,
CAST(sebo.OMD_CURRENT_RECORD_INDICATOR AS STRING) AS OMD_CURRENT_RECORD_INDICATOR,
CAST(sebo.OMD_DELETED_RECORD_INDICATOR AS STRING) AS OMD_DELETED_RECORD_INDICATOR,
CAST(sebo.OMD_RECORD_SOURCE_ID AS INT) AS OMD_RECORD_SOURCE_ID,
CAST(sebo.OMD_HASH_FULL_RECORD AS STRING) AS OMD_HASH_FULL_RECORD
from
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_ENCOUNTER_OMOP` heo 
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_ENCOUNTER_OMOP` leo 
on heo.HUB_ENCOUNTER_SK=leo.HUB_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_BDV_ENCOUNTER_OMOP` lbeo
on leo.HUB_SITE_PATIENT_SK =lbeo.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_ENCOUNTER_OMOP` lseo 
on leo.LNK_ENCOUNTER_SK=lseo.LNK_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_BDV_ENCOUNTER_OMOP` lsbeo 
on lbeo.LNK_BDV_ENCOUNTER_SK=lsbeo.LNK_BDV_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_ENCOUNTR_MD_EXCLD_SENSITIVE_DATA_OMOP` sebo 
on leo.HUB_ENCOUNTER_SK=sebo.HUB_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_BDV_ENCOUNTER_OMOP` sbeo
on lbeo.HUB_BDV_ENCOUNTER_SK=sbeo.HUB_BDV_ENCOUNTER_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON leo.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_MD_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
WHERE
	sebo.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND sebo.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND sbeo.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND sbeo.OMD_DELETED_RECORD_INDICATOR = 'N'
	AND lseo.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND lseo.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND lsbeo.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND lsbeo.OMD_DELETED_RECORD_INDICATOR = 'N'
    AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N'
)

select distinct * from encounter_md;

