

  create or replace view `nps-omop-project`.`C_SREDH_NPS_MI_STAGING_SIMPLIFIED_2021`.`src_matched_phc_bp`
  OPTIONS()
  as 


select 
cast(lbdv.HUB_SITE_PATIENT_SK as string) as PATIENT_NUMBER,
cast(hpo.OMD_NPS_SITE_ID as string) as SITE_ID,
cast(NULL as string) as PROVIDER_ID,
cast('PHC_BP' as string) as SOURCE_SYSTEM,
cast('SAT_SITE_PROVIDER_PHC_BP_OMOP' as string) as SOURCE_TABLE,
cast(hpo.PROVIDER_NUMBER as string) as PROVIDER_NUMBER,
cast(hpro.PRESCRIBER_NUMBER as string) as PRESCRIBER_NUMBER,
cast(null as string) as PROVIDER_SALUTATION,
cast(sspb.FIRST_NAME as string) as PROVIDER_FIRSTNAME,
cast(sspb.SURNAME as string) as PROVIDER_LASTNAME,
cast(null as string) as CRM_PERSON_ID,
cast(null as string) as PROVIDER_ACRRM,
cast(null as string) as PROVIDER_RACGP,
cast(NULL as string) as PROVIDER_AHPRA,
cast(null as string) as CRM_CONTACT_ID,
cast(null as string) as PROVIDER_PSA_NUMBER,
cast(NULL as string) as PROVIDER_GENDER,
cast(null as string) as PROVIDER_AGE_GROUP,
cast(null as string) as PROVIDER_MEDICAL_TRAINING_IN_AUSTRALIA,
cast(null as string) as PROVIDER_YEARS_PRACTICING_IN_AUSTRALIA,
cast(null as string) as PROVIDER_DECEASED_STATUS,
cast(null as string) as PROVIDER_CONTACT_RELATIONSHIP_START_DATE,
cast(null as string) as PROVIDER_CONTACT_RELATIONSHIP_END_DATE,
cast(null as string) as PROVIDER_MEDICINEINSIGHT_ROLE,
cast(null as string) as PROVIDER_REPORT_ACCESS_AUTHORISATION,
cast(null as string) as PROVIDER_WORK_STATUS,
cast(null as string) as PROVIDER_CONSENT_STATUS,
cast(null as string) as PROVIDER_CONSENT_COMMENTS,
cast(null as string) as PROVIDER_CONSENT_STATUS_START_DATE,
cast(null as string) as PROVIDER_CONSENT_STATUS_END_DATE,
cast(null as string) as PROVIDER_CIS_STATUS,
cast(null as string) as PROVIDER_TYPE,
cast(null as string) as PROVIDER_GP_MATCHING_ON_PRESCRIBER_NUMBER_INDICATOR,
cast(null as string) as PROVIDER_GP_MATCHING_ON_PROVIDER_NUMBER_INDICATOR,
cast(null as string) as PROVIDER_GP_MATCHING_ON_NAME_INDICATOR,
CAST(sspb.OMD_EFFECTIVE_DATETIME AS TIMESTAMP) AS OMD_EFFECTIVE_DATETIME,
CAST(sspb.OMD_SOURCE_ROW_ID AS INT) AS OMD_SOURCE_ROW_ID,
CAST(sspb.OMD_INSERT_MODULE_INSTANCE_ID AS INT) AS OMD_INSERT_MODULE_INSTANCE_ID,
CAST(sspb.OMD_EXPIRY_DATETIME AS TIMESTAMP) AS OMD_EXPIRY_DATETIME,
CAST(sspb.OMD_CURRENT_RECORD_INDICATOR AS STRING) AS OMD_CURRENT_RECORD_INDICATOR,
CAST(sspb.OMD_DELETED_RECORD_INDICATOR AS STRING) AS OMD_DELETED_RECORD_INDICATOR,
CAST(sspb.OMD_RECORD_SOURCE_ID AS INT) AS OMD_RECORD_SOURCE_ID,
CAST(sspb.OMD_HASH_FULL_RECORD AS STRING) AS OMD_HASH_FULL_RECORD
from 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PROVIDER_OMOP` hpo 
inner join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_LOGIN_SITE_PROVIDER_BP_OMOP` llsp 
on hpo.HUB_PROVIDER_SK = llsp.HUB_PROVIDER_SK 
inner join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LNK_BDV_PATIENT_USUAL_PROVIDER_OMOP` lbdv 
on llsp.HUB_LOGIN_SK = lbdv.HUB_LOGIN_SK
inner join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`LSAT_BDV_PATIENT_USUAL_PROVIDER_OMOP` lsbdv 
on lbdv.LNK_BDV_PATIENT_USUAL_PROVIDER_SK = lsbdv.LNK_BDV_PATIENT_USUAL_PROVIDER_SK
inner join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_PRACTITIONER_OMOP` hpro 
on llsp.HUB_PRACTITIONER_SK = hpro.HUB_PRACTITIONER_SK
inner join 
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PROVIDER_PHC_BP_OMOP` sspb 
on llsp.HUB_LOGIN_SK = sspb.HUB_LOGIN_SK
inner join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`HUB_SITE_PATIENT_OMOP` hsp
ON lbdv.HUB_SITE_PATIENT_SK = hsp.HUB_SITE_PATIENT_SK
INNER join
`nps-omop-project`.`B_SREDH_NPS_MI_SF_RDV_BDV_2021`.`SAT_SITE_PATIENT_PHC_BP_OMOP` ssp
ON hsp.HUB_SITE_PATIENT_SK = ssp.HUB_SITE_PATIENT_SK
where 
	sspb.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND sspb.OMD_DELETED_RECORD_INDICATOR = 'N'
	AND lsbdv.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND lsbdv.OMD_DELETED_RECORD_INDICATOR = 'N'
	AND ssp.OMD_CURRENT_RECORD_INDICATOR = 'Y'
	AND ssp.OMD_DELETED_RECORD_INDICATOR = 'N';

